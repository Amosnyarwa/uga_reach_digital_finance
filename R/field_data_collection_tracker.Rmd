---
title: "Tracker for field data collection"
author: "Anthony Twesigye"
date: "03/09/2021"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(dirname(inputFile), '/field_data_collection_tracker_', butteR::date_file_prefix(),'.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
# read packages
library(tidyverse)
library(lubridate)
library(glue)
library(leaflet)

# read data 
df_settlement_samples_required <- readxl::read_excel("../inputs/samples_settlement_definition.xlsx") %>% 
  mutate(settlement_name = str_replace(string = settlement_name, pattern = "_ii$", replacement = "_II")) %>% 
  select(settlement_name, smpl_sz)
df_host_samples_required <- readxl::read_excel("../inputs/samples_host_sub_definition.xlsx")%>% 
  select(sub_county_name, smpl_sz)

df_tool_data <- readxl::read_excel("../inputs/UGA2103_Financial_Service_Providers_Assessment_HH_Tool_June2021.xlsx") %>% 
  mutate(uuid = `_uuid`,
         start_date = as_date(start),
         start = as_datetime(start),
         end = as_datetime(end),
         latitude = as.numeric(`_geopoint_latitude`),
         longitude = as.numeric(`_geopoint_longitude`)) %>% 
  filter(consent == "yes", 
         start_date > as_date("2021-08-29"), 
         point_number != "13m.", 
         !start_date %in% c(as_date("2021-09-08"), as_date("2021-09-09"), 
                                    as_date("2021-09-21")),
         !str_detect(string = point_number, pattern = fixed('test', ignore_case = TRUE)),
         !uuid %in% c("27b0ffe2-8d47-4897-b402-1928fd23cfb3",
                              "40d216de-76db-42b7-9105-aea1ce234489",
                              "f2f648df-55d6-4b9d-93ca-aa87c3bc30c7",
                              "4167b891-b1ff-46b1-856b-532dd28e7a1e",
                              "d7bde578-cdc2-4d77-b31b-a15c4cec9d38"))
# days that contain data
df_days_for_data_collection <- df_tool_data %>% select(start_date) %>% unique() %>% arrange(start_date) %>% pull()

df_data_support_cl_log <- df_tool_data %>% 
  select(uuid, status,sub_county_name,	settlement_name, latitude,	longitude )
# cleaning log handling
df_cl_log <- read_csv(file = "../inputs/combined_logic_spatial_and_others_checks.csv") %>% 
  mutate(adjust_log = ifelse(is.na(adjust_log), "apply_suggested_change", adjust_log)) %>% 
  left_join(df_data_support_cl_log, by = "uuid")

# change_response logs that affect stats in the data collection progress
cl_log_change_response <- df_cl_log %>% 
  filter(type == "change_response", 
         !is.na(value),
         reviewed == 1, 
         adjust_log != "delete_log", 
         !issue_id %in% c("other_checks", "logic_c_main_language",  "logic_c_internet_awareness") ) %>% 
  select(uuid, name, value)

# updated tool data
df_updated_tool_data <- df_tool_data

# get uuids from cleaning log
uuids_chg_response <- cl_log_change_response %>% pull(uuid) %>% unique()

for (current_uuid in uuids_chg_response) {
  current_uuid_data <- cl_log_change_response %>% 
    filter(uuid == current_uuid) %>% 
    pivot_wider(names_from = "name", values_from = "value", uuid)
  # process current updates
  df_current_updated <- df_updated_tool_data %>% 
    rows_update(y = current_uuid_data, by = "uuid")
  # update the parent dataset with current updates
  df_updated_tool_data <- df_current_updated
}

# change some options in the table
dt_set_options<- function(x){
  DT::datatable(x,
                options = list(
                  autoWidth=F,
                  dom= 't',
                  list(list(width = '20%', targets = list(1,2,3,4,5)))
                )
  )
}

dt_with_modified_options <- function(x){
  DT::datatable(x,
                rownames = FALSE,
                options = list(
                  columnDefs = list(list(className = 'dt-center', targets = list(1,2))),
                  pageLength = 20,
                  initComplete = JS(
                    "function(settings, json) {",
                    "$(this.api().table().header()).css({'background-color': '#333', 'color': '#fff'});",
                    "}")
                )
  )
}

dt_options_fewcols <- function(x){
  DT::datatable(x,
                rownames = FALSE,
                options = list(
                  pageLength = 20,
                  initComplete = JS(
                    "function(settings, json) {",
                    "$(this.api().table().header()).css({'background-color': '#333', 'color': '#fff'});",
                    "}")
                )
  )
}


dt_enum_performance_options <- function(x){
  DT::datatable(x,
                rownames = FALSE,
                filter = 'top',
                options = list(
                  columnDefs = list(list(className = 'dt-center', targets = list(1,2))),
                  pageLength = 50,
                  initComplete = JS(
                    "function(settings, json) {",
                    "$(this.api().table().header()).css({'background-color': '#333', 'color': '#fff'});",
                    "}"),
                  order = list(list(1, 'desc'))
                )
  )
}

```

## Summary on the surveys done

>There are **`r nrow(df_updated_tool_data)`** total number of surveys done as of **`r df_days_for_data_collection[length(df_days_for_data_collection)]`**.

### Settlements:  **`r df_updated_tool_data %>% filter(status == "refugee") %>% nrow()`** surveys

```{r, echo = FALSE}
df_refugee_samp_per_settlement <- df_settlement_samples_required %>% 
  group_by(settlement_name) %>% 
  summarise(required_samples = sum(smpl_sz, na.rm = TRUE))

df_cl_surveys_for_deletion <- df_cl_log %>% 
  filter(status == "refugee", type == "remove_survey", reviewed == 1, adjust_log != "delete_log") %>%
  group_by(settlement_name) %>% 
  distinct(uuid) %>%
  summarise(surveys_for_deletion = n())

df_updated_tool_data %>% 
  filter(status == "refugee") %>% 
  group_by(district_name, settlement_name) %>% 
  summarise(number_of_surveys = n()) %>% 
  arrange(district_name) %>% 
  left_join(df_refugee_samp_per_settlement, by = "settlement_name") %>% 
  left_join(df_cl_surveys_for_deletion, by = "settlement_name") %>% 
  mutate(int.surveys_and_deletion = ifelse(is.na(surveys_for_deletion), number_of_surveys, number_of_surveys - surveys_for_deletion),
         remaining_surveys = required_samples - int.surveys_and_deletion ) %>% 
  select(-int.surveys_and_deletion) %>% 
  dt_with_modified_options()

```

### Host community: **`r df_updated_tool_data %>% filter(status == "host_community") %>% nrow()`** surveys

```{r, echo = FALSE}
df_host_samp_per_sub_county <- df_host_samples_required %>% 
  group_by(sub_county_name) %>% 
  summarise(required_samples = sum(smpl_sz, na.rm = TRUE))

df_cl_surveys_for_deletion <- df_cl_log %>% 
  filter(status == "host_community", type == "remove_survey", reviewed == 1, adjust_log != "delete_log") %>%
  group_by(sub_county_name) %>% 
  distinct(uuid) %>%
  summarise(surveys_for_deletion = n())

df_updated_tool_data %>% 
  filter(status == "host_community") %>% 
  group_by(district_name, sub_county_name) %>% 
  summarise(number_of_surveys = n()) %>% 
  arrange(district_name) %>% 
  left_join(df_host_samp_per_sub_county, by = "sub_county_name") %>% 
  left_join(df_cl_surveys_for_deletion, by = "sub_county_name") %>% 
  mutate(int.surveys_and_deletion = ifelse(is.na(surveys_for_deletion), number_of_surveys, number_of_surveys - surveys_for_deletion),
         remaining_surveys = required_samples - int.surveys_and_deletion ) %>% 
  select(-int.surveys_and_deletion) %>% 
  dt_with_modified_options()

```

### Daily enumerator performance

```{r, echo = FALSE}
df_updated_tool_data %>% 
  group_by(district_name, start_date, enumerator_id) %>% 
  summarise(number_of_interviews_done = n()) %>% 
  dt_with_modified_options()
```

## Looking into the cleaning log

### Number of issues by issue_id

```{r, echo = FALSE}
df_cl_log %>% 
  group_by(issue_id) %>% 
  summarise(number_of_issues_by_issue_id = n()) %>%
  dt_options_fewcols()
```
### Number of issues by enumerator

```{r, echo = FALSE}
df_cl_log %>% 
  group_by(enumerator_id) %>% 
  summarise(number_of_issues_by_enumerator_id = n()) %>%
  dt_options_fewcols()
```

### Number of issues by enumerator and issue_id

```{r, echo = FALSE}
df_cl_log %>% 
  group_by(enumerator_id, issue_id) %>% 
  summarise(number_of_issues_by_enumerator_and_issue_id = n()) %>%
  dt_options_fewcols()
```

### Enumerators with surveys for deletion

```{r, echo = FALSE}
df_cl_log %>% 
  filter(type == "remove_survey", reviewed == 1, adjust_log != "delete_log") %>% 
  group_by(enumerator_id) %>% 
  summarise(number_of_surveys_for_deletion_by_enumerator = n()) %>%
  dt_options_fewcols()
```

### Map of surveys for deletion

```{r, echo = FALSE, out.width="100%"}
# popup
labels_pts <- ~sprintf(
  "<strong>Status and Name: %s</strong><br/>
      Point Number :  <strong>%s</strong><br/>
      Issue ID :  <strong>%s</strong><br/>
      Issue :  <strong>%s</strong><br/>
      Enumerator ID :  <strong>%s</strong>",
  int.status, point_number, issue_id, issue, enumerator_id
) %>% 
  lapply(htmltools::HTML)

df_cl_log %>% 
  filter(type == "remove_survey", reviewed == 1, adjust_log != "delete_log") %>% 
  mutate(int.status = ifelse(status == "refugee", 
                             glue("{status}_{settlement_name}"), glue("{status}_{sub_county_name}"))) %>% 
  leaflet() %>% 
  addTiles() %>%
  addCircleMarkers(~longitude,
                   ~latitude,
                   popup = labels_pts,
                   radius = 10,
                   color = "red",
                   stroke = FALSE, fillOpacity = 0.9,
                   label = labels_pts,
                   clusterOptions = markerClusterOptions())
```

